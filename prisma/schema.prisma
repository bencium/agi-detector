// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  // Support for optional direct URL (Neon-specific)
  relationMode = "prisma"
}

model CrawlResult {
  id        String   @id @default(uuid())
  url       String
  title     String
  content   String
  timestamp DateTime @default(now())
  metadata  Json

  analysis AnalysisResult?

  @@index([url])
}

model AnalysisResult {
  id                String   @id @default(uuid())
  crawlId           String   @unique
  score             Float
  indicators        String[]
  confidence        Float
  timestamp         DateTime @default(now())
  severity          String?  // none, low, medium, high, critical
  evidenceQuality   String?  // speculative, circumstantial, direct
  requiresVerification Boolean @default(false)
  crossReferences   String[]
  explanation       String   @db.Text
  validatedAt       DateTime?
  lastValidation    Json?

  // Accuracy tracking fields
  groundTruthLabel  String?  // true_positive, false_positive, true_negative, false_negative
  groundTruthScore  Float?   // Expert-validated AGI relevance score (0-1)
  groundTruthNotes  String?  @db.Text
  reviewedBy        String?  // Expert/reviewer ID
  reviewedAt        DateTime?

  // Advanced analysis fields
  embedding         Float[]  // Semantic embedding vector for similarity matching
  language          String?  // Detected language (ISO 639-1 code)
  translatedContent String?  @db.Text // English translation if non-English
  filteredByHeuristics Boolean @default(false) // Pre-filtered by keyword heuristics
  heuristicScore    Float?   // Heuristic pre-filter score (0-1)
  mediaNoiseScore   Float?   // Score indicating marketing/hype language (0-1, higher = more noise)
  containsCode      Boolean @default(false)
  containsMath      Boolean @default(false)

  crawl CrawlResult @relation(fields: [crawlId], references: [id])
  historicalData HistoricalData[]

  @@index([score])
  @@index([timestamp])
  @@index([severity])
  @@index([groundTruthLabel])
  @@index([language])
}

model HistoricalData {
  id              String   @id @default(uuid())
  analysisId      String
  metric          String   // e.g., "score", "confidence", "indicator_count"
  value           Float
  timestamp       DateTime @default(now())
  
  analysis AnalysisResult @relation(fields: [analysisId], references: [id])
  
  @@index([metric, timestamp])
  @@index([analysisId])
}

model TrendAnalysis {
  id              String   @id @default(uuid())
  period          String   // daily, weekly, monthly
  avgScore        Float
  maxScore        Float
  minScore        Float
  totalAnalyses   Int
  criticalAlerts  Int
  timestamp       DateTime @default(now())

  @@index([period, timestamp])
}

model AccuracyMetrics {
  id                String   @id @default(uuid())
  period            String   // daily, weekly, monthly, all_time
  timestamp         DateTime @default(now())

  // Core metrics
  truePositives     Int
  falsePositives    Int
  trueNegatives     Int
  falseNegatives    Int

  // Calculated metrics
  precision         Float  // TP / (TP + FP)
  recall            Float  // TP / (TP + FN)
  f1Score           Float  // 2 * (precision * recall) / (precision + recall)
  accuracy          Float  // (TP + TN) / (TP + TN + FP + FN)
  falsePositiveRate Float  // FP / (FP + TN)
  falseNegativeRate Float  // FN / (FN + TP)

  // Additional context
  totalReviewed     Int
  avgConfidence     Float?
  notes             String? @db.Text

  @@index([period, timestamp])
}

model SourceMetrics {
  id                String   @id @default(uuid())
  sourceName        String
  sourceType        String   // research_blog, news, academic, social, code_repo
  timestamp         DateTime @default(now())

  // Crawl metrics
  totalArticles     Int
  successfulCrawls  Int
  failedCrawls      Int
  avgResponseTime   Float?   // milliseconds

  // Quality metrics
  avgAgiScore       Float?
  highSeverityCount Int
  falsePositiveRate Float?

  // Reliability
  uptime            Float?   // percentage
  lastSuccessful    DateTime?
  lastFailure       DateTime?
  errorRate         Float?

  @@index([sourceName])
  @@index([sourceType])
  @@index([timestamp])
}
